[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:mongodb]
command=/usr/bin/mongod --dbpath /data/mongodb --bind_ip 127.0.0.1
autostart=true
autorestart=true
stdout_logfile=/data/logs/mongodb.log
stderr_logfile=/data/logs/mongodb-error.log
priority=10

[program:mysql]
command=/usr/sbin/mysqld --user=mysql
autostart=true
autorestart=true
stdout_logfile=/data/logs/mysql.log
stderr_logfile=/data/logs/mysql-error.log
priority=10

[program:redis]
command=/usr/bin/redis-server --dir /data/redis --appendonly yes --bind 127.0.0.1
autostart=true
autorestart=true
stdout_logfile=/data/logs/redis.log
stderr_logfile=/data/logs/redis-error.log
priority=10

[program:backend]
command=/app/backend/claraverse
directory=/app/backend
autostart=true
autorestart=true
stdout_logfile=/data/logs/backend.log
stderr_logfile=/data/logs/backend-error.log
priority=20
startsecs=10
startretries=5
environment=
    ENVIRONMENT="%(ENV_ENVIRONMENT)s",
    DATABASE_URL="%(ENV_DATABASE_URL)s",
    MONGODB_URI="%(ENV_MONGODB_URI)s",
    REDIS_URL="%(ENV_REDIS_URL)s",
    FRONTEND_URL="%(ENV_FRONTEND_URL)s",
    BACKEND_URL="%(ENV_BACKEND_URL)s",
    ALLOWED_ORIGINS="%(ENV_ALLOWED_ORIGINS)s",
    ENCRYPTION_MASTER_KEY="%(ENV_ENCRYPTION_MASTER_KEY)s",
    JWT_SECRET="%(ENV_JWT_SECRET)s",
    UPLOAD_DIR="/data/uploads",
    SEARXNG_URL="%(ENV_SEARXNG_URL)s",
    SEARXNG_URLS="%(ENV_SEARXNG_URLS)s"

[program:e2b]
# Use simple subprocess-based executor (no E2B API key or Docker-in-Docker required)
command=python3 /app/e2b/main_simple.py
directory=/app/e2b
autostart=true
autorestart=true
stdout_logfile=/data/logs/e2b.log
stderr_logfile=/data/logs/e2b-error.log
priority=20
environment=EXECUTION_TIMEOUT="30",WORK_DIR="/tmp/code-executor"

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/data/logs/nginx.log
stderr_logfile=/data/logs/nginx-error.log
priority=30
