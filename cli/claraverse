#!/bin/bash
# ============================================
# ClaraVerse CLI - Your Private AI Workspace
# ============================================
# Install: curl -fsSL https://get.claraverse.app | bash
# Usage:   claraverse <command> [options]
# ============================================

set -e

VERSION="1.0.0"
GITHUB_REPO="claraverse-space/ClaraVerse"
DOCKER_IMAGE="ghcr.io/claraverse-space/claraverse:latest"
UPDATE_CHECK_URL="https://api.github.com/repos/${GITHUB_REPO}/releases/latest"
INSTALL_DIR="${CLARAVERSE_HOME:-$HOME/.claraverse}"
CONFIG_FILE="$INSTALL_DIR/config"
COMPOSE_FILE="$INSTALL_DIR/docker-compose.yml"
PROJECT_NAME="claraverse"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# ============================================
# Helper Functions
# ============================================

print_logo() {
    echo ""
    echo -e "${PURPLE}█▀▀ █   █▀█ █▀█ █▀█ █ █ █▀▀ █▀█ █▀▀ █▀▀${NC}"
    echo -e "${PURPLE}█   █   █▀█ █▀▄ █▀█ ▀▄▀ █▀▀ █▀▄ ▀▀█ █▀▀${NC}"
    echo -e "${PURPLE}▀▀▀ ▀▀▀ ▀ ▀ ▀ ▀ ▀ ▀  ▀  ▀▀▀ ▀ ▀ ▀▀▀ ▀▀▀${NC}"
    echo -e "    ${CYAN}Your Private AI Workspace${NC}"
    echo ""
}

log_info()    { echo -e "${BLUE}ℹ${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
log_error()   { echo -e "${RED}✗${NC} $1"; }
log_step()    { echo -e "${PURPLE}→${NC} $1"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }

check_docker() {
    if ! command_exists docker; then
        log_error "Docker is not installed"
        echo ""
        echo "Install Docker:"
        echo "  Linux:   curl -fsSL https://get.docker.com | sh"
        echo "  macOS:   brew install --cask docker"
        echo "  Windows: https://docs.docker.com/desktop/install/windows-install/"
        exit 1
    fi
    if ! docker info >/dev/null 2>&1; then
        log_error "Docker is not running"
        echo "  Linux:   sudo systemctl start docker"
        echo "  macOS:   Open Docker Desktop"
        exit 1
    fi
    # Check for docker compose (v2)
    if ! docker compose version >/dev/null 2>&1; then
        log_error "Docker Compose V2 is required"
        echo "  Update Docker to get Compose V2 built-in"
        exit 1
    fi
}

ensure_directories() {
    mkdir -p "$INSTALL_DIR"
}

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
}

save_config() {
    cat > "$CONFIG_FILE" << EOF
CLARAVERSE_PORT=${CLARAVERSE_PORT:-3000}
CLARAVERSE_VERSION=${VERSION}
LAST_UPDATE_CHECK=$(date +%s)
EOF
}

# Generate the docker-compose.yml that powers everything
generate_compose() {
    local port="${1:-3000}"

    cat > "$COMPOSE_FILE" << 'COMPOSEEOF'
# Generated by ClaraVerse CLI — do not edit manually
# Regenerate with: claraverse init

services:
  app:
    image: ghcr.io/claraverse-space/claraverse:latest
    container_name: claraverse
    ports:
      - "${CLARAVERSE_PORT:-3000}:3000"
    volumes:
      - app-data:/app/data
      - app-uploads:/app/uploads
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - DATABASE_URL=mysql://claraverse:claraverse@mysql:3306/claraverse?parseTime=true
      - MONGODB_URI=mongodb://mongodb:27017/claraverse
      - REDIS_URL=redis://redis:6379
      - SEARXNG_URL=http://searxng:8080
      - SEARXNG_URLS=http://searxng:8080
      - SERVE_FRONTEND=true
      - ALLOWED_ORIGINS=*
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_started
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  mysql:
    image: mysql:8.0
    container_name: claraverse-mysql
    environment:
      MYSQL_ROOT_PASSWORD: claraverse
      MYSQL_DATABASE: claraverse
      MYSQL_USER: claraverse
      MYSQL_PASSWORD: claraverse
    volumes:
      - mysql-data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password --skip-log-bin
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pclaraverse"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: claraverse-mongodb
    volumes:
      - mongodb-data:/data/db
    command: --quiet --logpath /dev/null
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: claraverse-redis
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  searxng:
    image: searxng/searxng:latest
    container_name: claraverse-searxng
    volumes:
      - searxng-data:/etc/searxng
      - INSTALL_DIR_PLACEHOLDER/searxng-settings.yml:/etc/searxng/settings.yml:ro
    restart: unless-stopped

volumes:
  app-data:
  app-uploads:
  mysql-data:
  mongodb-data:
  redis-data:
  searxng-data:
COMPOSEEOF

    # Replace placeholder with actual install dir path
    sed -i "s|INSTALL_DIR_PLACEHOLDER|${INSTALL_DIR}|g" "$COMPOSE_FILE"

    # Write SearXNG settings
    cat > "$INSTALL_DIR/searxng-settings.yml" << 'SEARXEOF'
use_default_settings: true

server:
  limiter: false
  secret_key: "claraverse-searxng-secret"
  image_proxy: true

search:
  formats:
    - html
    - json
  request_timeout: 10.0
  autocomplete: "duckduckgo"

engines:
  - name: duckduckgo
    engine: duckduckgo
    shortcut: ddg
  - name: google
    engine: google
    shortcut: g
  - name: bing
    engine: bing
    shortcut: bi
  - name: wikipedia
    engine: wikipedia
    shortcut: wp
SEARXEOF

    # Write the port into an .env for compose variable substitution
    echo "CLARAVERSE_PORT=${port}" > "$INSTALL_DIR/.env"
}

compose_cmd() {
    docker compose -f "$COMPOSE_FILE" --env-file "$INSTALL_DIR/.env" -p "$PROJECT_NAME" "$@"
}

is_running() {
    # Only check compose-managed containers (not old standalone ones)
    compose_cmd ps --status running --format json 2>/dev/null | grep -q '"app"' 2>/dev/null && return 0
    compose_cmd ps --status running 2>/dev/null | grep -q "claraverse-app" && return 0
    return 1
}

# Remove leftover containers from old CLI versions (standalone, non-compose)
cleanup_legacy() {
    for name in claraverse claraverse-search; do
        if docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^${name}$"; then
            # Only remove if not managed by our compose project
            local project=$(docker inspect --format '{{index .Config.Labels "com.docker.compose.project"}}' "$name" 2>/dev/null || echo "")
            if [ "$project" != "$PROJECT_NAME" ]; then
                docker stop "$name" 2>/dev/null || true
                docker rm "$name" 2>/dev/null || true
            fi
        fi
    done
}

is_installed() {
    [ -f "$COMPOSE_FILE" ] && return 0
    return 1
}

wait_for_healthy() {
    local max_wait=${1:-120}
    local waited=0
    echo -n "Waiting for ClaraVerse to be ready"
    while [ $waited -lt $max_wait ]; do
        local health=$(docker inspect --format='{{.State.Health.Status}}' claraverse 2>/dev/null || echo "unknown")
        if [ "$health" = "healthy" ]; then
            echo ""
            return 0
        fi
        echo -n "."
        sleep 2
        waited=$((waited + 2))
    done
    echo ""
    return 1
}

# ============================================
# Commands
# ============================================

cmd_init() {
    print_logo
    log_info "Initializing ClaraVerse..."
    echo ""

    check_docker
    cleanup_legacy
    ensure_directories

    local port="${1:-3000}"

    if is_running; then
        log_warning "ClaraVerse is already running"
        echo ""
        echo "Access: http://localhost:$port"
        echo ""
        echo "Commands:"
        echo "  claraverse status  - Check status"
        echo "  claraverse stop    - Stop ClaraVerse"
        echo "  claraverse restart - Restart ClaraVerse"
        exit 0
    fi

    # Generate compose file
    log_step "Configuring services..."
    generate_compose "$port"

    # Pull images
    log_step "Pulling images (this may take a few minutes)..."
    compose_cmd pull --quiet 2>/dev/null || compose_cmd pull
    log_success "Images pulled"

    # Start everything
    log_step "Starting ClaraVerse on port $port..."
    compose_cmd up -d

    # Wait for healthy
    if wait_for_healthy 120; then
        log_success "ClaraVerse is ready!"
        echo ""
        echo -e "${GREEN}============================================${NC}"
        echo -e "${GREEN}  ClaraVerse is running!${NC}"
        echo -e "${GREEN}============================================${NC}"
        echo ""
        echo -e "  ${BOLD}Access:${NC} http://localhost:${port}"
        echo ""
        echo -e "  ${BOLD}First Steps:${NC}"
        echo "    1. Open http://localhost:${port} in browser"
        echo "    2. Register account (first user = admin)"
        echo "    3. Add AI provider keys in Settings"
        echo "       Or just have Ollama running — it's auto-detected!"
        echo ""
        echo -e "  ${BOLD}Commands:${NC}"
        echo "    claraverse status   - Check status"
        echo "    claraverse logs     - View logs"
        echo "    claraverse stop     - Stop ClaraVerse"
        echo "    claraverse update   - Update to latest"
        echo ""

        CLARAVERSE_PORT=$port
        save_config
    else
        log_error "ClaraVerse failed to start properly"
        echo "Check logs: claraverse logs"
        exit 1
    fi
}

cmd_start() {
    check_docker

    if ! is_installed; then
        log_warning "ClaraVerse is not initialized. Run: claraverse init"
        exit 1
    fi

    if is_running; then
        log_info "ClaraVerse is already running"
        return
    fi

    log_step "Starting ClaraVerse..."
    compose_cmd up -d
    load_config

    if wait_for_healthy 60; then
        log_success "ClaraVerse started"
        echo "Access: http://localhost:${CLARAVERSE_PORT:-3000}"
    else
        log_error "Failed to start"
        exit 1
    fi
}

cmd_stop() {
    check_docker

    if ! is_installed; then
        log_info "ClaraVerse is not installed"
        return
    fi

    log_step "Stopping ClaraVerse..."
    compose_cmd down
    log_success "ClaraVerse stopped"
}

cmd_restart() {
    check_docker

    if ! is_installed; then
        log_warning "ClaraVerse is not initialized. Run: claraverse init"
        exit 1
    fi

    log_step "Restarting ClaraVerse..."
    compose_cmd restart

    if wait_for_healthy 60; then
        log_success "ClaraVerse restarted"
        load_config
        echo "Access: http://localhost:${CLARAVERSE_PORT:-3000}"
    else
        log_error "Failed to restart properly"
        exit 1
    fi
}

cmd_status() {
    check_docker
    load_config

    echo ""
    echo -e "${BOLD}ClaraVerse Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    if ! is_installed; then
        echo -e "Status:  ${RED}● Not Installed${NC}"
        echo ""
        echo "Initialize with: claraverse init"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        return
    fi

    # Show all container statuses
    local services=("claraverse:App" "claraverse-mysql:MySQL" "claraverse-mongodb:MongoDB" "claraverse-redis:Redis" "claraverse-searxng:SearXNG")
    for svc in "${services[@]}"; do
        local container="${svc%%:*}"
        local label="${svc##*:}"
        local status=$(docker inspect --format='{{.State.Status}}' "$container" 2>/dev/null || echo "not found")
        case "$status" in
            running)
                echo -e "  ${label}:$(printf '%*s' $((10-${#label})) '')${GREEN}● Running${NC}"
                ;;
            exited|stopped)
                echo -e "  ${label}:$(printf '%*s' $((10-${#label})) '')${YELLOW}● Stopped${NC}"
                ;;
            *)
                echo -e "  ${label}:$(printf '%*s' $((10-${#label})) '')${RED}● Not found${NC}"
                ;;
        esac
    done

    echo ""

    local health=$(docker inspect --format='{{.State.Health.Status}}' claraverse 2>/dev/null || echo "unknown")
    case "$health" in
        healthy)   echo -e "  Health:   ${GREEN}● Healthy${NC}" ;;
        unhealthy) echo -e "  Health:   ${RED}● Unhealthy${NC}" ;;
        *)         echo -e "  Health:   ${YELLOW}● $health${NC}" ;;
    esac

    echo -e "  Port:     ${CLARAVERSE_PORT:-3000}"
    echo -e "  URL:      http://localhost:${CLARAVERSE_PORT:-3000}"

    if is_running; then
        local stats=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}" claraverse 2>/dev/null)
        if [ -n "$stats" ]; then
            echo -e "  CPU:      $(echo "$stats" | cut -f1)"
            echo -e "  Memory:   $(echo "$stats" | cut -f2)"
        fi
    fi

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

cmd_logs() {
    check_docker

    local service="app"
    local follow=""
    local lines="100"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow) follow="-f"; shift ;;
            -n|--lines)  lines="$2"; shift 2 ;;
            all)         service=""; shift ;;
            *)           service="$1"; shift ;;
        esac
    done

    if [ -n "$service" ]; then
        compose_cmd logs $follow --tail "$lines" "$service" 2>&1
    else
        compose_cmd logs $follow --tail "$lines" 2>&1
    fi
}

cmd_update() {
    check_docker
    load_config

    if ! is_installed; then
        log_warning "ClaraVerse is not initialized. Run: claraverse init"
        exit 1
    fi

    log_info "Checking for updates..."

    log_step "Pulling latest images..."
    compose_cmd pull --quiet 2>/dev/null || compose_cmd pull

    log_step "Recreating containers..."
    compose_cmd up -d --force-recreate

    if wait_for_healthy 120; then
        log_success "ClaraVerse updated successfully!"
        echo "Access: http://localhost:${CLARAVERSE_PORT:-3000}"
        save_config
    else
        log_error "Update failed — ClaraVerse is not healthy"
        echo "Check logs: claraverse logs"
        exit 1
    fi
}

cmd_uninstall() {
    check_docker

    echo -e "${YELLOW}This will remove ClaraVerse and all its containers.${NC}"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        exit 0
    fi

    if is_installed; then
        log_step "Stopping containers..."
        compose_cmd down 2>/dev/null || true
    fi

    read -p "Remove all data (databases, uploads)? (y/N) " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_step "Removing data volumes..."
        compose_cmd down -v 2>/dev/null || true
    fi

    log_step "Removing config..."
    rm -rf "$INSTALL_DIR"

    log_success "ClaraVerse uninstalled"
    echo ""
    echo "To remove the CLI tool:"
    echo "  sudo rm /usr/local/bin/claraverse"
}

cmd_clean() {
    check_docker

    echo -e "${YELLOW}⚠ This will remove ALL ClaraVerse data:${NC}"
    echo "  - All databases (MongoDB, MySQL)"
    echo "  - All uploaded files"
    echo "  - All user accounts"
    echo ""
    echo -e "${RED}This action cannot be undone!${NC}"
    echo ""
    read -p "Type 'DELETE' to confirm: " confirm
    if [ "$confirm" != "DELETE" ]; then
        log_info "Cancelled"
        exit 0
    fi

    log_step "Stopping and removing everything..."
    compose_cmd down -v 2>/dev/null || true
    cleanup_legacy

    log_success "All ClaraVerse data removed"
    echo ""
    echo "Start fresh with: claraverse init"
}

cmd_shell() {
    check_docker
    if ! is_running; then
        log_error "ClaraVerse is not running"
        exit 1
    fi
    docker exec -it claraverse /bin/bash 2>/dev/null || docker exec -it claraverse /bin/sh
}

cmd_backup() {
    check_docker
    ensure_directories
    local backup_file="${1:-claraverse-backup-$(date +%Y%m%d-%H%M%S).tar.gz}"

    log_step "Creating backup..."

    docker run --rm \
        -v claraverse_app-data:/app-data \
        -v claraverse_app-uploads:/app-uploads \
        -v claraverse_mysql-data:/mysql-data \
        -v claraverse_mongodb-data:/mongodb-data \
        -v "$(pwd):/backup" \
        ubuntu:22.04 \
        tar czf "/backup/$backup_file" -C / app-data app-uploads mysql-data mongodb-data

    log_success "Backup created: $backup_file"
}

cmd_config() {
    load_config
    case "${1:-show}" in
        show)
            echo ""
            echo -e "${BOLD}ClaraVerse Configuration${NC}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Install Dir:  $INSTALL_DIR"
            echo "Compose File: $COMPOSE_FILE"
            echo "Port:         ${CLARAVERSE_PORT:-3000}"
            echo "Image:        $DOCKER_IMAGE"
            echo "Version:      $VERSION"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            ;;
        set)
            local key="$2" value="$3"
            if [ -z "$key" ] || [ -z "$value" ]; then
                log_error "Usage: claraverse config set <key> <value>"
                exit 1
            fi
            case "$key" in
                port)
                    CLARAVERSE_PORT="$value"
                    save_config
                    generate_compose "$value"
                    log_success "Port set to $value"
                    log_info "Restart to apply: claraverse restart"
                    ;;
                *) log_error "Unknown config key: $key"; exit 1 ;;
            esac
            ;;
        *) log_error "Usage: claraverse config [show|set <key> <value>]"; exit 1 ;;
    esac
}

cmd_version() {
    echo "ClaraVerse CLI v$VERSION"
    echo "Image: $DOCKER_IMAGE"
}

cmd_help() {
    print_logo
    echo -e "${BOLD}Usage:${NC} claraverse <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  init [port]      Initialize and start (default port: 3000)"
    echo "  start            Start ClaraVerse"
    echo "  stop             Stop ClaraVerse"
    echo "  restart          Restart ClaraVerse"
    echo "  status           Show status of all services"
    echo "  logs [-f] [svc]  View logs (-f to follow, svc: app/mysql/mongodb/redis/searxng/all)"
    echo "  update           Update to latest version"
    echo "  backup [file]    Create backup of all data"
    echo "  config           View or set configuration"
    echo "  shell            Open shell in app container"
    echo "  clean            Remove all data and start fresh"
    echo "  uninstall        Remove ClaraVerse completely"
    echo "  version          Show version information"
    echo "  help             Show this help message"
    echo ""
    echo -e "${BOLD}Services (5 containers under 'claraverse'):${NC}"
    echo "  claraverse          App (Go backend + React frontend)"
    echo "  claraverse-mysql    MySQL 8.0"
    echo "  claraverse-mongodb  MongoDB 7"
    echo "  claraverse-redis    Redis 7"
    echo "  claraverse-searxng  SearXNG (web search)"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  claraverse init              # Start on port 3000"
    echo "  claraverse init 8080         # Start on port 8080"
    echo "  claraverse logs -f           # Follow app logs"
    echo "  claraverse logs -f all       # Follow all service logs"
    echo "  claraverse status            # Show all container statuses"
    echo ""
    echo "Documentation: https://github.com/${GITHUB_REPO}"
    echo ""
}

# ============================================
# Main
# ============================================

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        init)       cmd_init "$@" ;;
        start)      cmd_start "$@" ;;
        stop)       cmd_stop "$@" ;;
        restart)    cmd_restart "$@" ;;
        status)     cmd_status "$@" ;;
        logs)       cmd_logs "$@" ;;
        update)     cmd_update "$@" ;;
        backup)     cmd_backup "$@" ;;
        config)     cmd_config "$@" ;;
        shell)      cmd_shell "$@" ;;
        clean)      cmd_clean "$@" ;;
        uninstall)  cmd_uninstall "$@" ;;
        version|-v|--version) cmd_version "$@" ;;
        help|-h|--help)       cmd_help "$@" ;;
        *) log_error "Unknown command: $command"; echo "Run 'claraverse help' for usage"; exit 1 ;;
    esac
}

main "$@"
