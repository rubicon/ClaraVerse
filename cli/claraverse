#!/bin/bash
# ============================================
# ClaraVerse CLI - Your Private AI Workspace
# ============================================
# Install: curl -fsSL https://get.claraverse.ai | bash
# Usage:   claraverse <command> [options]
# ============================================

set -e

# Version and URLs
VERSION="1.0.0"
GITHUB_REPO="claraverse-space/ClaraVerse"
DOCKER_IMAGE="ghcr.io/claraverse-space/claraverse:latest"
SEARXNG_IMAGE="searxng/searxng:latest"
UPDATE_CHECK_URL="https://api.github.com/repos/${GITHUB_REPO}/releases/latest"
INSTALL_DIR="${CLARAVERSE_HOME:-$HOME/.claraverse}"
DATA_DIR="${CLARAVERSE_DATA:-$INSTALL_DIR/data}"
CONFIG_FILE="$INSTALL_DIR/config"
CONTAINER_NAME="claraverse"
SEARXNG_CONTAINER="claraverse-search"
NETWORK_NAME="claraverse-net"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# ============================================
# Helper Functions
# ============================================

print_logo() {
    echo ""
    echo -e "${PURPLE}█▀▀ █   █▀█ █▀█ █▀█ █ █ █▀▀ █▀█ █▀▀ █▀▀${NC}"
    echo -e "${PURPLE}█   █   █▀█ █▀▄ █▀█ ▀▄▀ █▀▀ █▀▄ ▀▀█ █▀▀${NC}"
    echo -e "${PURPLE}▀▀▀ ▀▀▀ ▀ ▀ ▀ ▀ ▀ ▀  ▀  ▀▀▀ ▀ ▀ ▀▀▀ ▀▀▀${NC}"
    echo -e "    ${CYAN}Your Private AI Workspace${NC}"
    echo ""
}

log_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1"
}

log_step() {
    echo -e "${PURPLE}→${NC} $1"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check Docker is installed and running
check_docker() {
    if ! command_exists docker; then
        log_error "Docker is not installed"
        echo ""
        echo "Install Docker:"
        echo "  Linux:   curl -fsSL https://get.docker.com | sh"
        echo "  macOS:   brew install --cask docker"
        echo "  Windows: https://docs.docker.com/desktop/install/windows-install/"
        exit 1
    fi

    if ! docker info >/dev/null 2>&1; then
        log_error "Docker is not running"
        echo ""
        echo "Start Docker:"
        echo "  Linux:   sudo systemctl start docker"
        echo "  macOS:   Open Docker Desktop"
        echo "  Windows: Start Docker Desktop"
        exit 1
    fi
}

# Ensure directories exist
ensure_directories() {
    mkdir -p "$INSTALL_DIR" "$DATA_DIR"
}

# Load config
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
}

# Save config
save_config() {
    cat > "$CONFIG_FILE" << EOF
# ClaraVerse Configuration
CLARAVERSE_PORT=${CLARAVERSE_PORT:-80}
CLARAVERSE_VERSION=${VERSION}
LAST_UPDATE_CHECK=$(date +%s)
EOF
}

# Get container status
get_status() {
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "running"
    elif docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        echo "stopped"
    else
        echo "not_installed"
    fi
}

# Get SearXNG container status
get_searxng_status() {
    if docker ps --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        echo "running"
    elif docker ps -a --format '{{.Names}}' | grep -q "^${SEARXNG_CONTAINER}$"; then
        echo "stopped"
    else
        echo "not_installed"
    fi
}

# Ensure Docker network exists
ensure_network() {
    if ! docker network ls --format '{{.Name}}' | grep -q "^${NETWORK_NAME}$"; then
        docker network create "$NETWORK_NAME" >/dev/null 2>&1 || true
    fi
}

# Start SearXNG container
start_searxng() {
    local searxng_status=$(get_searxng_status)

    if [ "$searxng_status" = "running" ]; then
        return 0
    fi

    if [ "$searxng_status" = "stopped" ]; then
        docker start "$SEARXNG_CONTAINER" >/dev/null
        return 0
    fi

    # Pull and start SearXNG
    log_step "Setting up web search (SearXNG)..."
    docker pull "$SEARXNG_IMAGE" 2>&1 | grep -E "(Pull|Digest|Status)" || true

    docker run -d \
        --name "$SEARXNG_CONTAINER" \
        --network "$NETWORK_NAME" \
        -v claraverse-searxng:/etc/searxng \
        --restart unless-stopped \
        "$SEARXNG_IMAGE" >/dev/null

    # Wait for SearXNG to initialize and create settings.yml
    sleep 5

    # Enable JSON format for API access (required for ClaraVerse web search)
    docker exec "$SEARXNG_CONTAINER" sh -c "
        if grep -q 'formats:' /etc/searxng/settings.yml 2>/dev/null; then
            if ! grep -q '- json' /etc/searxng/settings.yml; then
                sed -i '/formats:/a\\    - json' /etc/searxng/settings.yml
            fi
        fi
    " 2>/dev/null || true

    # Restart to apply config
    docker restart "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true

    log_success "Web search enabled"
}

# Stop SearXNG container
stop_searxng() {
    local searxng_status=$(get_searxng_status)
    if [ "$searxng_status" = "running" ]; then
        docker stop "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true
    fi
}

# Get container health
get_health() {
    docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_NAME" 2>/dev/null || echo "unknown"
}

# Wait for healthy status
wait_for_healthy() {
    local max_wait=${1:-120}
    local waited=0

    echo -n "Waiting for ClaraVerse to be ready"
    while [ $waited -lt $max_wait ]; do
        local health=$(get_health)
        if [ "$health" = "healthy" ]; then
            echo ""
            return 0
        fi
        echo -n "."
        sleep 2
        waited=$((waited + 2))
    done
    echo ""
    return 1
}

# Check for updates
check_for_updates() {
    if ! command_exists curl; then
        return 1
    fi

    local latest=$(curl -sf "$UPDATE_CHECK_URL" 2>/dev/null | grep -o '"tag_name": *"[^"]*"' | head -1 | cut -d'"' -f4)
    if [ -n "$latest" ] && [ "$latest" != "v$VERSION" ]; then
        echo "$latest"
        return 0
    fi
    return 1
}

# ============================================
# Commands
# ============================================

cmd_init() {
    print_logo
    log_info "Initializing ClaraVerse..."
    echo ""

    check_docker
    ensure_directories

    local port="${1:-80}"

    # Check if already running
    local status=$(get_status)
    if [ "$status" = "running" ]; then
        log_warning "ClaraVerse is already running"
        echo ""
        echo "Access: http://localhost:$port"
        echo ""
        echo "Commands:"
        echo "  claraverse status  - Check status"
        echo "  claraverse stop    - Stop ClaraVerse"
        echo "  claraverse restart - Restart ClaraVerse"
        exit 0
    fi

    # Create Docker network
    log_step "Setting up network..."
    ensure_network

    # Start SearXNG for web search
    start_searxng

    # Pull latest image
    log_step "Pulling latest ClaraVerse image..."
    docker pull "$DOCKER_IMAGE" 2>&1 | grep -E "(Pull|Digest|Status)" || true
    log_success "Image pulled"

    # Remove old container if exists
    if [ "$status" = "stopped" ]; then
        log_step "Removing old container..."
        docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
    fi

    # Start container with SearXNG connection
    log_step "Starting ClaraVerse on port $port..."
    docker run -d \
        --name "$CONTAINER_NAME" \
        --network "$NETWORK_NAME" \
        -p "${port}:80" \
        -v claraverse-data:/data \
        -e "SEARXNG_URL=http://${SEARXNG_CONTAINER}:8080" \
        -e "SEARXNG_URLS=http://${SEARXNG_CONTAINER}:8080" \
        --restart unless-stopped \
        "$DOCKER_IMAGE" >/dev/null

    # Wait for healthy
    if wait_for_healthy 120; then
        log_success "ClaraVerse is ready!"
        echo ""
        echo -e "${GREEN}============================================${NC}"
        echo -e "${GREEN}  ClaraVerse is running!${NC}"
        echo -e "${GREEN}============================================${NC}"
        echo ""
        echo -e "  ${BOLD}Access:${NC} http://localhost:${port}"
        echo ""
        echo -e "  ${BOLD}Features:${NC}"
        echo "    - AI Chat & Assistants"
        echo "    - Web Search (SearXNG)"
        echo "    - Code Execution (E2B)"
        echo "    - Image Generation"
        echo ""
        echo -e "  ${BOLD}First Steps:${NC}"
        echo "    1. Open http://localhost:${port} in browser"
        echo "    2. Register account (first user = admin)"
        echo "    3. Add AI provider keys in Settings"
        echo ""
        echo -e "  ${BOLD}Commands:${NC}"
        echo "    claraverse status   - Check status"
        echo "    claraverse logs     - View logs"
        echo "    claraverse stop     - Stop ClaraVerse"
        echo "    claraverse update   - Update to latest"
        echo ""

        # Save config
        CLARAVERSE_PORT=$port
        save_config
    else
        log_error "ClaraVerse failed to start properly"
        echo ""
        echo "Check logs: claraverse logs"
        exit 1
    fi
}

cmd_start() {
    check_docker

    local status=$(get_status)
    case "$status" in
        "running")
            log_info "ClaraVerse is already running"
            ;;
        "stopped")
            # Ensure network and SearXNG are running
            ensure_network
            start_searxng

            log_step "Starting ClaraVerse..."
            docker start "$CONTAINER_NAME" >/dev/null
            if wait_for_healthy 60; then
                log_success "ClaraVerse started"
                load_config
                echo "Access: http://localhost:${CLARAVERSE_PORT:-80}"
            else
                log_error "Failed to start"
                exit 1
            fi
            ;;
        "not_installed")
            log_warning "ClaraVerse is not initialized"
            echo "Run: claraverse init"
            exit 1
            ;;
    esac
}

cmd_stop() {
    check_docker

    local status=$(get_status)
    if [ "$status" = "running" ]; then
        log_step "Stopping ClaraVerse..."
        docker stop "$CONTAINER_NAME" >/dev/null
        stop_searxng
        log_success "ClaraVerse stopped"
    else
        log_info "ClaraVerse is not running"
        stop_searxng
    fi
}

cmd_restart() {
    check_docker

    # Ensure network and SearXNG are running
    ensure_network
    start_searxng

    log_step "Restarting ClaraVerse..."
    docker restart "$CONTAINER_NAME" >/dev/null 2>&1 || {
        log_error "ClaraVerse is not running. Use: claraverse start"
        exit 1
    }

    if wait_for_healthy 60; then
        log_success "ClaraVerse restarted"
        load_config
        echo "Access: http://localhost:${CLARAVERSE_PORT:-80}"
    else
        log_error "Failed to restart properly"
        exit 1
    fi
}

cmd_status() {
    check_docker
    load_config

    echo ""
    echo -e "${BOLD}ClaraVerse Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    local status=$(get_status)
    local health=$(get_health)
    local searxng_status=$(get_searxng_status)

    case "$status" in
        "running")
            echo -e "Main:    ${GREEN}● Running${NC}"
            case "$health" in
                "healthy")
                    echo -e "Health:  ${GREEN}● Healthy${NC}"
                    ;;
                "unhealthy")
                    echo -e "Health:  ${RED}● Unhealthy${NC}"
                    ;;
                *)
                    echo -e "Health:  ${YELLOW}● Starting${NC}"
                    ;;
            esac

            # SearXNG status
            case "$searxng_status" in
                "running")
                    echo -e "Search:  ${GREEN}● Running${NC}"
                    ;;
                "stopped")
                    echo -e "Search:  ${YELLOW}● Stopped${NC}"
                    ;;
                *)
                    echo -e "Search:  ${RED}● Not installed${NC}"
                    ;;
            esac

            echo -e "Port:    ${CLARAVERSE_PORT:-80}"
            echo -e "URL:     http://localhost:${CLARAVERSE_PORT:-80}"

            # Show resource usage
            local stats=$(docker stats --no-stream --format "{{.CPUPerc}}\t{{.MemUsage}}" "$CONTAINER_NAME" 2>/dev/null)
            if [ -n "$stats" ]; then
                local cpu=$(echo "$stats" | cut -f1)
                local mem=$(echo "$stats" | cut -f2)
                echo -e "CPU:     $cpu"
                echo -e "Memory:  $mem"
            fi
            ;;
        "stopped")
            echo -e "Status:  ${YELLOW}● Stopped${NC}"
            echo ""
            echo "Start with: claraverse start"
            ;;
        "not_installed")
            echo -e "Status:  ${RED}● Not Installed${NC}"
            echo ""
            echo "Initialize with: claraverse init"
            ;;
    esac

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Check for updates (async, don't block)
    if [ -n "${LAST_UPDATE_CHECK:-}" ]; then
        local now=$(date +%s)
        local diff=$((now - LAST_UPDATE_CHECK))
        # Check every 24 hours
        if [ $diff -gt 86400 ]; then
            local latest=$(check_for_updates)
            if [ -n "$latest" ]; then
                echo -e "${YELLOW}Update available: $latest${NC}"
                echo "Run: claraverse update"
                echo ""
            fi
        fi
    fi
}

cmd_logs() {
    check_docker

    local follow=""
    local lines="100"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow)
                follow="-f"
                shift
                ;;
            -n|--lines)
                lines="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    docker logs $follow --tail "$lines" "$CONTAINER_NAME" 2>&1
}

cmd_update() {
    check_docker
    load_config

    log_info "Checking for updates..."

    # Ensure network and SearXNG
    ensure_network
    start_searxng

    # Pull latest images
    log_step "Pulling latest images..."
    local pull_output=$(docker pull "$DOCKER_IMAGE" 2>&1)
    docker pull "$SEARXNG_IMAGE" >/dev/null 2>&1 || true

    if echo "$pull_output" | grep -q "Image is up to date"; then
        log_success "Already running the latest version"
        return 0
    fi

    log_success "New version downloaded"

    # Check if running
    local status=$(get_status)
    local was_running=false

    if [ "$status" = "running" ]; then
        was_running=true
        log_step "Stopping current instance..."
        docker stop "$CONTAINER_NAME" >/dev/null
    fi

    if [ "$status" != "not_installed" ]; then
        log_step "Removing old container..."
        docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
    fi

    # Start new container with SearXNG connection
    log_step "Starting updated ClaraVerse..."
    docker run -d \
        --name "$CONTAINER_NAME" \
        --network "$NETWORK_NAME" \
        -p "${CLARAVERSE_PORT:-80}:80" \
        -v claraverse-data:/data \
        -e "SEARXNG_URL=http://${SEARXNG_CONTAINER}:8080" \
        -e "SEARXNG_URLS=http://${SEARXNG_CONTAINER}:8080" \
        --restart unless-stopped \
        "$DOCKER_IMAGE" >/dev/null

    if wait_for_healthy 120; then
        log_success "ClaraVerse updated successfully!"
        echo "Access: http://localhost:${CLARAVERSE_PORT:-80}"

        # Update config
        save_config
    else
        log_error "Update failed - ClaraVerse is not healthy"
        echo "Check logs: claraverse logs"
        exit 1
    fi
}

cmd_uninstall() {
    check_docker

    echo -e "${YELLOW}This will remove ClaraVerse and all its data.${NC}"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        exit 0
    fi

    log_step "Stopping ClaraVerse..."
    docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
    docker stop "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true

    log_step "Removing containers..."
    docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
    docker rm "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true

    read -p "Remove all data? (y/N) " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_step "Removing data volumes..."
        docker volume rm claraverse-data >/dev/null 2>&1 || true
        docker volume rm claraverse-searxng >/dev/null 2>&1 || true
    fi

    log_step "Removing network..."
    docker network rm "$NETWORK_NAME" >/dev/null 2>&1 || true

    log_step "Removing config..."
    rm -rf "$INSTALL_DIR"

    log_success "ClaraVerse uninstalled"
    echo ""
    echo "To remove the CLI tool:"
    echo "  sudo rm /usr/local/bin/claraverse"
}

cmd_clean() {
    check_docker

    echo -e "${YELLOW}⚠ This will remove ALL ClaraVerse data:${NC}"
    echo "  - All databases (MongoDB, MySQL)"
    echo "  - All uploaded files"
    echo "  - All user accounts"
    echo "  - All search data"
    echo ""
    echo -e "${RED}This action cannot be undone!${NC}"
    echo ""
    read -p "Are you sure you want to delete everything? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        exit 0
    fi

    # Double confirm
    read -p "Type 'DELETE' to confirm: " confirm
    if [ "$confirm" != "DELETE" ]; then
        log_info "Cancelled"
        exit 0
    fi

    log_step "Stopping containers..."
    docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
    docker stop "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true

    log_step "Removing containers..."
    docker rm "$CONTAINER_NAME" >/dev/null 2>&1 || true
    docker rm "$SEARXNG_CONTAINER" >/dev/null 2>&1 || true

    log_step "Removing all data volumes..."
    docker volume rm claraverse-data >/dev/null 2>&1 || true
    docker volume rm claraverse-searxng >/dev/null 2>&1 || true

    log_step "Removing network..."
    docker network rm "$NETWORK_NAME" >/dev/null 2>&1 || true

    log_success "All ClaraVerse data has been removed"
    echo ""
    echo "To start fresh:"
    echo "  claraverse init"
}

cmd_shell() {
    check_docker

    local status=$(get_status)
    if [ "$status" != "running" ]; then
        log_error "ClaraVerse is not running"
        exit 1
    fi

    docker exec -it "$CONTAINER_NAME" /bin/bash
}

cmd_backup() {
    check_docker
    ensure_directories

    local backup_file="${1:-claraverse-backup-$(date +%Y%m%d-%H%M%S).tar.gz}"

    log_step "Creating backup..."

    # Stop if running for consistent backup
    local was_running=false
    if [ "$(get_status)" = "running" ]; then
        was_running=true
        log_step "Stopping ClaraVerse for backup..."
        docker stop "$CONTAINER_NAME" >/dev/null
    fi

    # Create backup from volume
    docker run --rm \
        -v claraverse-data:/data \
        -v "$(pwd):/backup" \
        ubuntu:22.04 \
        tar czf "/backup/$backup_file" -C /data .

    # Restart if was running
    if [ "$was_running" = true ]; then
        log_step "Restarting ClaraVerse..."
        docker start "$CONTAINER_NAME" >/dev/null
    fi

    log_success "Backup created: $backup_file"
}

cmd_restore() {
    check_docker

    local backup_file="$1"

    if [ -z "$backup_file" ]; then
        log_error "Usage: claraverse restore <backup-file>"
        exit 1
    fi

    if [ ! -f "$backup_file" ]; then
        log_error "Backup file not found: $backup_file"
        exit 1
    fi

    echo -e "${YELLOW}This will replace all current data with the backup.${NC}"
    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Cancelled"
        exit 0
    fi

    # Stop if running
    if [ "$(get_status)" = "running" ]; then
        log_step "Stopping ClaraVerse..."
        docker stop "$CONTAINER_NAME" >/dev/null
    fi

    # Restore backup
    log_step "Restoring from backup..."
    docker run --rm \
        -v claraverse-data:/data \
        -v "$(cd "$(dirname "$backup_file")" && pwd):/backup" \
        ubuntu:22.04 \
        bash -c "rm -rf /data/* && tar xzf /backup/$(basename "$backup_file") -C /data"

    log_success "Backup restored"

    # Start
    log_step "Starting ClaraVerse..."
    docker start "$CONTAINER_NAME" >/dev/null 2>&1 || cmd_init
}

cmd_config() {
    load_config

    case "${1:-show}" in
        show)
            echo ""
            echo -e "${BOLD}ClaraVerse Configuration${NC}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Install Dir: $INSTALL_DIR"
            echo "Data Dir:    $DATA_DIR"
            echo "Port:        ${CLARAVERSE_PORT:-80}"
            echo "Version:     $VERSION"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            ;;
        set)
            local key="$2"
            local value="$3"
            if [ -z "$key" ] || [ -z "$value" ]; then
                log_error "Usage: claraverse config set <key> <value>"
                exit 1
            fi
            case "$key" in
                port)
                    CLARAVERSE_PORT="$value"
                    save_config
                    log_success "Port set to $value"
                    log_info "Restart to apply: claraverse restart"
                    ;;
                *)
                    log_error "Unknown config key: $key"
                    exit 1
                    ;;
            esac
            ;;
        *)
            log_error "Unknown config command: $1"
            echo "Usage: claraverse config [show|set <key> <value>]"
            exit 1
            ;;
    esac
}

cmd_version() {
    echo "ClaraVerse CLI v$VERSION"
    echo ""

    # Show Docker image info if running
    local status=$(get_status)
    local searxng_status=$(get_searxng_status)

    if [ "$status" = "running" ] || [ "$status" = "stopped" ]; then
        local image_id=$(docker inspect --format='{{.Image}}' "$CONTAINER_NAME" 2>/dev/null | cut -c8-19)
        echo "Main Image:   $DOCKER_IMAGE"
        [ -n "$image_id" ] && echo "              ($image_id)"
    fi

    if [ "$searxng_status" = "running" ] || [ "$searxng_status" = "stopped" ]; then
        echo "Search Image: $SEARXNG_IMAGE"
    fi

    echo ""
    echo "Components:"
    echo "  - ClaraVerse (All-in-One)"
    echo "    Backend, Frontend, MongoDB, MySQL, Redis, E2B"
    echo "  - SearXNG (Web Search)"
}

cmd_help() {
    print_logo
    echo -e "${BOLD}Usage:${NC} claraverse <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo "  init [port]      Initialize and start ClaraVerse (default port: 80)"
    echo "  start            Start ClaraVerse"
    echo "  stop             Stop ClaraVerse"
    echo "  restart          Restart ClaraVerse"
    echo "  status           Show status and health"
    echo "  logs [-f]        View logs (-f to follow)"
    echo "  update           Update to latest version"
    echo "  backup [file]    Create backup of all data"
    echo "  restore <file>   Restore from backup"
    echo "  config           View or set configuration"
    echo "  shell            Open shell in container"
    echo "  clean            Remove all data and start fresh"
    echo "  uninstall        Remove ClaraVerse completely"
    echo "  version          Show version information"
    echo "  help             Show this help message"
    echo ""
    echo -e "${BOLD}What's Included:${NC}"
    echo "  - AI Chat & Assistants"
    echo "  - Web Search (SearXNG)"
    echo "  - Code Execution (E2B)"
    echo "  - Image Generation"
    echo "  - MongoDB, MySQL, Redis"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  claraverse init              # Start on port 80"
    echo "  claraverse init 8080         # Start on port 8080"
    echo "  claraverse logs -f           # Follow logs"
    echo "  claraverse backup            # Create backup"
    echo "  claraverse config set port 8080"
    echo ""
    echo -e "${BOLD}Environment Variables:${NC}"
    echo "  CLARAVERSE_HOME    Installation directory (default: ~/.claraverse)"
    echo "  CLARAVERSE_DATA    Data directory (default: ~/.claraverse/data)"
    echo ""
    echo "Documentation: https://docs.claraverse.ai"
    echo "Issues:        https://github.com/${GITHUB_REPO}/issues"
    echo ""
}

# ============================================
# Main
# ============================================

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        init)
            cmd_init "$@"
            ;;
        start)
            cmd_start "$@"
            ;;
        stop)
            cmd_stop "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        status)
            cmd_status "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        update)
            cmd_update "$@"
            ;;
        backup)
            cmd_backup "$@"
            ;;
        restore)
            cmd_restore "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        shell)
            cmd_shell "$@"
            ;;
        clean)
            cmd_clean "$@"
            ;;
        uninstall)
            cmd_uninstall "$@"
            ;;
        version|-v|--version)
            cmd_version "$@"
            ;;
        help|-h|--help)
            cmd_help "$@"
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'claraverse help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
